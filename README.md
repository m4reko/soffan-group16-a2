# Continuous Integration #
Continuous Integration is a simple continuous integration server that builds a Gradle project and reports the status of it for every push command done to the remote repository. It reports the build status as a commit status on Github. The server run as a GitHub Webhook.

## Travis-CI Status ##
[![Build Status](https://travis-ci.com/m4reko/soffan-group16-a2.svg?branch=main)](https://travis-ci.com/m4reko/soffan-group16-a2)

## How to Use It ##
### Requirements ###
Java `11+`, Gradle `6.8.2`, ngrok `2.3.35`

### Building and Testing ###
`./gradlew build` both assembles the project and run the JUnit tests.

### Running ###
To enable the report commit status function two environment variables is needed to authenticate towards GitHub.

```bash
export CI_NAME={your_github_username}
export CI_TOKEN={your_personal_github_token}
```

The personal GitHub token can be generated in `User settings >> Developer settings >> Personal access tokens`.

After the environment variables is set, `./gradlew run` will start the server on `localhost:8080`.

### Starting `ngrok` ###
`ngrok http 8080` will start ngrok for port 8080 and print the url in the terminal.

### Github Settings ###
To connect the server to GitHub it has to be added as a webhook in our repo:

1. `Repo settings >> Webhooks >> Add webhook`
2. Payload URL: ngrok URL (eg. `http://12345678.ngrok.io`)
3. Set the content type: application/json

### Accessing the Build Logs ###
`/buildlogs` lists the latest builds and their corresponding unique id.

`/buildlogs/{unique_id}` will get the build log of a specific build.

## How it Works ##
### Building and Testing ###
The server gets a POST request from a webhook connection and clones the repo that generated that POST request. It the starts a new process which runs `./gradlew build` in the cloned repository. This assembles the project and runs all its unit tests. The output from this process, which is the build log, is stored in a file.

#### Unit Test ####
There are two parts to this that are unit tested separately.
Firstly, the cloning is tested by only cloning a project and asserting that we cloned the files to the right location.
Secondly, the building is tested by building a project included in the test resources of this project and asserting that we get the correct build status.

### Status Reporting ###
The status reporting works by taking the output of the build function and turning it to the corresponding commit status message. It then spawns a HTTP client that creates a POST request including GitHub credentials and the commit status.

#### Unit Test ####
The unit tests for the commit status reporting reports a commit status to an old test branch of this repo and asserts that it gets the correct response code from GitHub.

## File Structure ##
We are using a common Gradle folder structure generated by the `gradle init`

|Folder/File|Description|
| --- | --- |
|app/src/main/java/ciserver|Contains the source code of the CI server|
|app/src/main/java/ciserver/ContinuousIntegrationServer.java|CI Server object; main function to run the server|
|app/src/main/java/ciserver/Repository.java|Repository object: clone, build, report commit status|
|app/src/main/java/ciserver/Payload.java|Payload object: JSON parse|
|app/src/test/java/ciserver/ContinuousIntegrationServerTest.java|Contains unit test for the overall program|
|app/src/test/java/ciserver/PayloadTest.java|Contains unit test for the payload object.|
|app/src/test/java/ciserver/RepositoryTest.java|Contains unit test for the repository class.|
|app/src/test/resources|Contains hard coded simple resources for the unit test to use|
|app/build.gradle|Contains the dependencies of the project which is handled by Gradle|
|.travis.yml|Contains Travis CI configurations|

## Statement of Contributions
Markus Wessl√©n - Create gradle template, implement `Payload` class, implement `reportCommitStatus`, fix and refactor `build` function to support new process method,

Justin Arieltan -

David Ek - Implement `Payload` class, implement `reportCommitStatus`,

Jiarui Tan -

## Pass with Distinction ##
- Most commits are linked to a related issue. Issues and commits have descriptive names and some contain additional relevant information.
- Build history is stored and viewable in the browser.
